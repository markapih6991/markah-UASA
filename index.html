<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Semakan Markah SMK Puteri Wangsa</title>
    <!-- Muat naik Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Muat naik fon Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Konfigurasi Tailwind untuk menggunakan fon Inter
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Latar belakang yang lembut */
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Animasi putaran untuk ikon loading */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        /* Gaya tambahan untuk tag details */
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex items-center justify-center p-4">

    <!-- Kad Utama -->
    <div class="w-full max-w-md bg-white rounded-xl shadow-2xl p-6 md:p-8">

        <!-- Bahagian Tajuk -->
        <div class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-blue-700">
                Portal Semakan Markah SMK Puteri Wangsa
            </h1>
            <p class="text-base text-gray-600 mt-1">Ujian Akhir Sesi Akademik 2025</p>
        </div>

        <!-- === BAHAGIAN ADMIN (DISEMBUNYIKAN UNTUK VERSI PELAJAR) === -->
        <!-- Nota: Kelas 'hidden' ditambah di sini untuk menyembunyikannya -->
        <details id="adminSection" class="hidden mb-6 bg-blue-50 rounded-lg border border-blue-100 overflow-hidden group">
            <summary class="flex items-center justify-between w-full p-3 font-medium text-sm text-blue-800 cursor-pointer hover:bg-blue-100 focus:outline-none">
                <span>üõ†Ô∏è (Mod Guru) Klik untuk Muat Naik Data</span>
                <svg class="w-5 h-5 text-blue-500 transition-transform transform group-open:rotate-180" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </summary>
            <div class="p-4 border-t border-blue-100 space-y-4 bg-white">
                <div>
                    <label for="dataTextArea" class="block text-sm font-medium text-gray-700 mb-1">
                        Tampal Data CSV Di Sini:
                    </label>
                    <textarea id="dataTextArea" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 text-sm" placeholder="Contoh: 1.11E+11;NAMA;KELAS;BM;80"></textarea>
                </div>
                <button id="loadDataButton" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-green-700 transition-transform transform hover:scale-105 text-sm">
                    Muat Naik Data
                </button>
                <div id="dataLoadMessage" class="hidden text-center font-medium p-2 rounded-lg text-sm"></div>
            </div>
        </details>
        <!-- === TAMAT BAHAGIAN ADMIN === -->

        <!-- Bahagian Input Pengguna (Kini Sentiasa Aktif) -->
        <div id="searchSection" class="space-y-4">
            <div>
                <label for="studentIdInput" class="block text-sm font-medium text-gray-700 mb-1">
                    Masukkan No Kad Pengenalan
                </label>
                <!-- 'disabled' telah dibuang dari input ini -->
                <input type="text" id="studentIdInput" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg" 
                       placeholder="Contoh: 111009...">
            </div>
            
            <!-- 'disabled' telah dibuang dari butang ini -->
            <button id="checkButton" 
                    class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-transform transform hover:scale-105">
                Semak Markah
            </button>
        </div>

        <!-- Bahagian Mesej Ralat -->
        <div id="errorContainer" class="hidden mt-4 text-center text-red-700 font-medium bg-red-100 p-3 rounded-lg"></div>

        <!-- Bahagian Paparan Keputusan -->
        <div id="resultsContainer" class="hidden mt-8">
            <div class="text-center border-b border-gray-200 pb-4 mb-4">
                <h2 id="studentName" class="text-2xl font-bold text-gray-900 uppercase"></h2>
                <p id="studentClass" class="text-lg text-gray-600 mt-1"></p>
            </div>
            <div id="marksList" class="space-y-4"></div>

            <!-- Bahagian Gemini -->
            <div id="geminiSection" class="hidden mt-6 border-t border-gray-200 pt-6">
                <button id="generateCommentButton" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-lg hover:bg-indigo-700 transition-all transform hover:scale-105">
                    ‚ú® Jana Ulasan Prestasi AI
                </button>
                <div id="geminiLoading" class="hidden mt-4 text-center text-gray-600">
                    <div class="flex items-center justify-center">
                        <div class="loader"></div><span>Menganalisis prestasi...</span>
                    </div>
                </div>
                <div id="geminiResult" class="hidden mt-4 bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                    <h4 class="text-lg font-semibold text-indigo-900 mb-2">Ulasan dari Penasihat AI:</h4>
                    <p id="geminiCommentText" class="text-base text-indigo-800 whitespace-pre-wrap"></p>
                    <button id="readAloudButton" class="hidden mt-4 w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-green-700 transition-all text-sm">
                        üîä Sebutkan Keputusan & Ulasan
                    </button>
                    <div id="ttsLoading" class="hidden mt-4 text-center text-gray-600">
                        <div class="flex items-center justify-center">
                            <div class="loader"></div><span>Menjana audio...</span>
                        </div>
                    </div>
                    <audio id="audioPlayer" class="hidden"></audio>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- (1) DATA PELAJAR (PENTING UNTUK VERCEL) ---
        
        /* ARAHAN PENTING UNTUK CIKGU:
           Supaya data ini kekal di Vercel dan Mod Guru boleh disembunyikan,
           Cikgu MESTI tampal data di dalam tanda kurungan siku [ ] di bawah.
           
           Formatnya mestilah:
           { kod_pelajar: "123", nama: "ALI", kelas: "5A", subjek: "BM", markah: 80 },
           { kod_pelajar: "123", nama: "ALI", kelas: "5A", subjek: "BI", markah: 70 },
           ...
        */

        let studentData = [
            // --- TAMPAL DATA JSON ANDA DI SINI ---
            // Contoh (boleh padam baris contoh ini selepas anda masukkan data sebenar):
            { kod_pelajar: "P101", nama: "Ahmad Bin Abu", kelas: "5 Amanah", subjek: "Bahasa Melayu", markah: 85 },
            { kod_pelajar: "P101", nama: "Ahmad Bin Abu", kelas: "5 Amanah", subjek: "English", markah: 72 },
            
            // ... data selebihnya ...
        ];

        // --- FUNGSI PARSE DATA (Untuk kegunaan Mod Guru jika diaktifkan semula) ---
        function parseStudentData(rawData) {
            const allRecords = [];
            const lines = rawData.trim().split('\n'); 
            lines.forEach(line => {
                if (line.trim() === "") return; 
                const parts = line.split(';'); 
                if (parts.length < 3) return; 
                let kodPelajar = parts[0].trim();
                if (kodPelajar.includes('E+')) { kodPelajar = Number(kodPelajar).toString(); }
                const nama = parts[1].trim();
                const kelas = parts[2].trim();
                for (let i = 3; i < parts.length; i += 2) {
                    const subjek = parts[i] ? parts[i].trim() : null;
                    const markah = parts[i + 1] ? parts[i + 1].trim() : null;
                    if (subjek && markah && subjek !== "" && markah !== "") {
                        allRecords.push({ kod_pelajar: kodPelajar, nama: nama, kelas: kelas, subjek: subjek, markah: parseInt(markah, 10) });
                    }
                }
            });
            return allRecords;
        }

        // --- (A) TETAPAN API GEMINI ---
        const apiKey = ""; // Kunci API diuruskan oleh persekitaran ini
        const textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const ttsApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

        // (2) Rujukan DOM
        const studentIdInput = document.getElementById('studentIdInput');
        const checkButton = document.getElementById('checkButton');
        const resultsContainer = document.getElementById('resultsContainer');
        const studentNameEl = document.getElementById('studentName');
        const studentClassEl = document.getElementById('studentClass');
        const marksListEl = document.getElementById('marksList');
        const errorContainer = document.getElementById('errorContainer');
        const geminiSection = document.getElementById('geminiSection');
        const generateCommentButton = document.getElementById('generateCommentButton');
        const geminiLoading = document.getElementById('geminiLoading');
        const geminiResult = document.getElementById('geminiResult');
        const geminiCommentText = document.getElementById('geminiCommentText');
        const readAloudButton = document.getElementById('readAloudButton');
        const ttsLoading = document.getElementById('ttsLoading');
        const audioPlayer = document.getElementById('audioPlayer');
        const dataTextArea = document.getElementById('dataTextArea');
        const loadDataButton = document.getElementById('loadDataButton');
        const dataLoadMessage = document.getElementById('dataLoadMessage');
        const adminSection = document.getElementById('adminSection');

        let currentStudentRecords = [];
        let fullTextToRead = "";

        // --- FUNGSI MUAT NAIK DATA (ADMIN) ---
        function loadData() {
            const rawData = dataTextArea.value;
            if (rawData.trim() === "") {
                showMessage('Ruangan data tidak boleh kosong.', true); return;
            }
            try {
                const newData = parseStudentData(rawData);
                if (newData.length === 0) throw new Error('Format data tidak sah.');
                studentData = newData; // KEMASKINI DATA UTAMA
                showMessage(`Berjaya memuat naik ${studentData.length} rekod.`, false);
                setTimeout(() => { adminSection.removeAttribute('open'); dataLoadMessage.classList.add('hidden'); }, 1500);
            } catch (error) {
                showMessage(`Ralat: ${error.message}`, true);
            }
        }
        function showMessage(msg, isError) {
            dataLoadMessage.textContent = msg;
            dataLoadMessage.className = `text-center font-medium p-2 rounded-lg text-sm ${isError ? 'text-red-700 bg-red-100' : 'text-green-700 bg-green-100'}`;
        }

        // --- LOGIK UTAMA ---
        function calculateGrade(markah) {
            const mark = parseInt(markah, 10);
            if (mark >= 82) return { gred: 'A', status: 'Cemerlang' };
            if (mark >= 66) return { gred: 'B', status: 'Kepujian' };
            if (mark >= 50) return { gred: 'C', status: 'Baik' };
            if (mark >= 35) return { gred: 'D', status: 'Memuaskan' };
            if (mark >= 20) return { gred: 'E', status: 'Mencapai Tahap Minimum' };
            return { gred: 'F', status: 'Belum Mencapai Tahap Minimum' };
        }

        function checkMarks() {
            let rawInput = studentIdInput.value.trim();
            resetUI();

            if (!rawInput) { showError('Sila masukkan Kod Pelajar atau No KP anda.'); return; }
            
            // Jika tiada data langsung dalam sistem
            if (studentData.length === 0) { showError('Harap maaf, data markah belum dimuat naik ke dalam sistem.'); return; }

            let normalizedInput = rawInput.toUpperCase().includes('E+') ? Number(rawInput).toString() : rawInput;
            const finalInputId = normalizedInput.toUpperCase();
            const matchedRecords = studentData.filter(s => s.kod_pelajar.toUpperCase() === finalInputId);

            if (matchedRecords.length === 0) { showError('Kod Pelajar tidak ditemui. Sila semak dan cuba lagi.'); return; }

            displayResults(matchedRecords);
        }

        function resetUI() {
            resultsContainer.classList.add('hidden'); errorContainer.classList.add('hidden');
            marksListEl.innerHTML = ''; geminiSection.classList.add('hidden'); geminiResult.classList.add('hidden');
            generateCommentButton.classList.remove('hidden'); readAloudButton.classList.add('hidden');
            audioPlayer.pause(); audioPlayer.src = "";
        }
        function showError(msg) { errorContainer.textContent = msg; errorContainer.classList.remove('hidden'); }

        function displayResults(records) {
            currentStudentRecords = records;
            studentNameEl.textContent = records[0].nama.toUpperCase();
            studentClassEl.textContent = `Kelas: ${records[0].kelas}`;
            fullTextToRead = `Keputusan untuk ${records[0].nama}, dari ${records[0].kelas}.\n`;

            records.forEach(r => {
                const { gred, status } = calculateGrade(r.markah);
                fullTextToRead += `${r.subjek}: ${r.markah}%, Gred ${gred}.\n`;
                marksListEl.innerHTML += `
                    <div class="bg-gray-50 p-5 rounded-xl shadow-md border border-gray-200">
                        <p class="text-xl font-semibold text-gray-900">${r.subjek}</p>
                        <div class="mt-2 flex items-end justify-between">
                            <div><p class="text-4xl font-bold text-blue-600">${r.markah}%</p></div>
                            <div class="text-right"><p class="text-2xl font-semibold text-blue-500">${gred}</p><p class="text-sm text-gray-600">${status}</p></div>
                        </div>
                    </div>`;
            });
            resultsContainer.classList.remove('hidden'); geminiSection.classList.remove('hidden');
        }

        // --- FUNGSI GEMINI (TIDAK BERUBAH) ---
        async function fetchWithBackoff(url, options, maxRetries=3) {
             let delay=1000; for(let i=0;i<maxRetries;i++){ try{const res=await fetch(url,options);if(res.ok)return res.json();if(res.status===429){await new Promise(r=>setTimeout(r,delay));delay*=2;}else throw new Error(res.status);}catch(e){if(i===maxRetries-1)throw e;await new Promise(r=>setTimeout(r,delay));delay*=2;}}}

        async function handleGenerateComment() {
            if (currentStudentRecords.length === 0) return;
            geminiLoading.classList.remove('hidden'); generateCommentButton.classList.add('hidden');
            const marksStr = currentStudentRecords.map(r => `${r.subjek}: ${r.markah}% (${calculateGrade(r.markah).gred})`).join(', ');
            const payload = { contents: [{ parts: [{ text: `Tolong berikan ulasan untuk pelajar: ${currentStudentRecords[0].nama}, Kelas: ${currentStudentRecords[0].kelas}. Markah: ${marksStr}.` }] }], systemInstruction: { parts: [{ text: "Anda adalah guru penasihat AI yang positif. Beri ulasan ringkas (2-3 ayat) dalam Bahasa Melayu, puji yang cemerlang, beri galakan untuk yang lemah." }] } };
            try {
                const res = await fetchWithBackoff(textApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const comment = res.candidates?.[0]?.content?.parts?.[0]?.text;
                if (comment) { geminiCommentText.innerText = comment; geminiResult.classList.remove('hidden'); readAloudButton.classList.remove('hidden'); fullTextToRead += `\nUlasan AI:\n ${comment}`; }
            } catch (e) { geminiCommentText.innerText = 'Maaf, ulasan tidak dapat dijana.'; geminiResult.classList.remove('hidden'); }
            finally { geminiLoading.classList.add('hidden'); }
        }

        async function handleReadAloud() {
            if (!fullTextToRead) return;
            ttsLoading.classList.remove('hidden'); readAloudButton.disabled = true;
            try {
                const res = await fetchWithBackoff(ttsApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: fullTextToRead }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } }, model: "gemini-2.5-flash-preview-tts" }) });
                const audioData = res?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (audioData) {
                     const wav = pcmToWav(new Int16Array(base64ToArrayBuffer(audioData)), 24000);
                     audioPlayer.src = URL.createObjectURL(wav); audioPlayer.play();
                }
            } catch (e) { console.error(e); ttsLoading.innerText = 'Gagal menjana audio.'; }
            finally { ttsLoading.classList.add('hidden'); readAloudButton.disabled = false; }
        }
        function base64ToArrayBuffer(b64){const b=atob(b64),l=b.length,u=new Uint8Array(l);for(let i=0;i<l;i++)u[i]=b.charCodeAt(i);return u.buffer;}
        function pcmToWav(pcm,r){const c=1,b=16,d=pcm.length*2,bf=new ArrayBuffer(44+d),v=new DataView(bf);wS(v,0,'RIFF');v.setUint32(4,36+d,true);wS(v,8,'WAVE');wS(v,12,'fmt ');v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,c,true);v.setUint32(24,r,true);v.setUint32(28,r*c*2,true);v.setUint16(32,c*2,true);v.setUint16(34,b,true);wS(v,36,'data');v.setUint32(40,d,true);for(let i=0;i<pcm.length;i++)v.setInt16(44+i*2,pcm[i],true);return new Blob([v],{type:'audio/wav'});}
        function wS(v,o,s){for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i));}

        // Pautkan Event Listeners
        loadDataButton.addEventListener('click', loadData);
        checkButton.addEventListener('click', checkMarks);
        generateCommentButton.addEventListener('click', handleGenerateComment);
        readAloudButton.addEventListener('click', handleReadAloud);
        studentIdInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') checkMarks(); });
    </script>
</body>
</html>
