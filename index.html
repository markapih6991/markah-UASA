<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Semakan Markah SMK Puteri Wangsa</title>
    <!-- Muat naik Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Muat naik fon Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Konfigurasi Tailwind untuk menggunakan fon Inter
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Latar belakang yang lembut */
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Animasi putaran untuk ikon loading */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        /* Gaya tambahan untuk tag details */
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        /* Gaya untuk senarai HTML yang dijana oleh AI */
        .ai-content ul, .ai-content ol { margin-left: 1.5rem; margin-top: 0.5rem; list-style-type: disc; }
        .ai-content ol { list-style-type: decimal; }
        .ai-content li { margin-bottom: 0.25rem; }
        .ai-content strong { color: #4338ca; } /* indigo-700 */
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex items-center justify-center p-4">

    <!-- Kad Utama -->
    <div class="w-full max-w-2xl bg-white rounded-xl shadow-2xl p-6 md:p-8">

        <!-- Bahagian Tajuk & Logo -->
        <div class="text-center mb-6">
            <!-- RUANGAN LOGO SEKOLAH -->
            <!-- Letakkan fail 'logo.png' di dalam folder yang sama dengan fail ini di GitHub -->
            <img src="logo.jpg" 
                 onerror="this.src='https://placehold.co/150x150/e2e8f0/1e40af?text=LOGO+SEKOLAH'"
                 alt="Logo Sekolah" 
                 class="mx-auto h-24 w-auto mb-4 object-contain transition-transform hover:scale-105">
            
            <h1 class="text-2xl md:text-3xl font-bold text-blue-700">
                Portal Semakan Markah SMK Puteri Wangsa
            </h1>
            <p class="text-base text-gray-600 mt-1">Ujian Akhir Sesi Akademik 2025</p>
        </div>

        <!-- === BAHAGIAN ADMIN (DISEMBUNYIKAN UNTUK PELAJAR) === -->
        <details id="adminSection" class="hidden mb-6 bg-blue-50 rounded-lg border border-blue-100 overflow-hidden group">
            <summary class="flex items-center justify-between w-full p-3 font-medium text-sm text-blue-800 cursor-pointer hover:bg-blue-100 focus:outline-none">
                <span>üõ†Ô∏è (Mod Guru) Klik untuk Muat Naik Data</span>
                <svg class="w-5 h-5 text-blue-500 transition-transform transform group-open:rotate-180" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </summary>
            <div class="p-4 border-t border-blue-100 space-y-4 bg-white">
                <div>
                    <label for="dataTextArea" class="block text-sm font-medium text-gray-700 mb-1">
                        Tampal Data CSV Di Sini:
                    </label>
                    <textarea id="dataTextArea" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 text-sm" placeholder="Contoh: 111009011234;NAMA;KELAS;BM;80"></textarea>
                </div>
                <button id="loadDataButton" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-green-700 transition-transform transform hover:scale-105 text-sm">
                    Muat Naik Data
                </button>
                <div id="dataLoadMessage" class="hidden text-center font-medium p-2 rounded-lg text-sm"></div>
            </div>
        </details>
        <!-- === TAMAT BAHAGIAN ADMIN === -->

        <!-- Bahagian Input Pengguna -->
        <div id="searchSection" class="space-y-4 max-w-md mx-auto">
            <div>
                <label for="studentIdInput" class="block text-sm font-medium text-gray-700 mb-1">
                    Masukkan No Kad Pengenalan
                </label>
                <input type="text" id="studentIdInput" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg" 
                       placeholder="Contoh: 111009011234...">
            </div>
            
            <button id="checkButton" 
                    class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-transform transform hover:scale-105">
                Semak Markah
            </button>
        </div>

        <!-- Bahagian Mesej Ralat -->
        <div id="errorContainer" class="hidden mt-4 text-center text-red-700 font-medium bg-red-100 p-3 rounded-lg max-w-md mx-auto"></div>

        <!-- Bahagian Paparan Keputusan -->
        <div id="resultsContainer" class="hidden mt-8">
            <div class="text-center border-b border-gray-200 pb-4 mb-4">
                <h2 id="studentName" class="text-2xl font-bold text-gray-900 uppercase"></h2>
                <p id="studentClass" class="text-lg text-gray-600 mt-1"></p>
            </div>
            <div id="marksList" class="space-y-4 max-w-md mx-auto"></div>

            <!-- Bahagian Gemini AI Features -->
            <div id="geminiSection" class="hidden mt-8 border-t border-gray-200 pt-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Analisis Pintar AI (Gemini)</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Butang Ulasan Asas -->
                    <button id="generateCommentButton" class="col-span-1 md:col-span-2 w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-all transform hover:scale-[1.02] flex items-center justify-center">
                        <span>‚ú® Jana Ulasan Prestasi</span>
                    </button>

                    <!-- Butang Tambahan AI -->
                    <button id="studyPlanButton" class="hidden w-full bg-purple-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-purple-700 transition-all transform hover:scale-[1.02] flex items-center justify-center">
                        <span>‚ú® Jana Pelan Ulangkaji</span>
                    </button>
                     <button id="careerButton" class="hidden w-full bg-teal-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-teal-700 transition-all transform hover:scale-[1.02] flex items-center justify-center">
                        <span>‚ú® Cadangan Bidang/Kerjaya</span>
                    </button>
                </div>

                <!-- Loading Indicator -->
                <div id="geminiLoading" class="hidden mt-6 text-center text-gray-600 bg-gray-50 p-4 rounded-lg">
                    <div class="flex items-center justify-center">
                        <div class="loader"></div><span id="loadingText">Sedang menganalisis...</span>
                    </div>
                </div>

                <!-- Hasil AI 1: Ulasan Umum -->
                <div id="geminiResult" class="hidden mt-6 bg-indigo-50 p-5 rounded-xl border border-indigo-200 ai-content">
                    <h4 class="text-lg font-bold text-indigo-900 mb-2 flex items-center">
                        ü§ñ Ulasan Penasihat AI:
                    </h4>
                    <div id="geminiCommentText" class="text-base text-indigo-900 leading-relaxed"></div>
                    <button id="readAloudButton" class="mt-4 w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-green-700 transition-all text-sm flex items-center justify-center">
                        <span class="mr-2">üîä</span> Dengar Ulasan
                    </button>
                     <div id="ttsLoading" class="hidden mt-2 text-center text-sm text-gray-600 flex items-center justify-center">
                        <div class="loader w-4 h-4 mr-2"></div>Menjana audio...
                    </div>
                    <audio id="audioPlayer" class="hidden"></audio>
                </div>

                <!-- Hasil AI 2: Pelan Ulangkaji -->
                <div id="studyPlanResult" class="hidden mt-6 bg-purple-50 p-5 rounded-xl border border-purple-200 ai-content">
                     <h4 class="text-lg font-bold text-purple-900 mb-2 flex items-center">
                        üìö Pelan Ulangkaji Disyorkan:
                    </h4>
                    <div id="studyPlanText" class="text-base text-purple-900 leading-relaxed"></div>
                </div>

                <!-- Hasil AI 3: Kerjaya -->
                 <div id="careerResult" class="hidden mt-6 bg-teal-50 p-5 rounded-xl border border-teal-200 ai-content">
                     <h4 class="text-lg font-bold text-teal-900 mb-2 flex items-center">
                        üöÄ Cadangan Laluan Masa Depan:
                    </h4>
                    <div id="careerText" class="text-base text-teal-900 leading-relaxed"></div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- (1) DATA PELAJAR (WAJIB ISI UNTUK GITHUB/VERCEL) ---
        // Data ini mesti diisi di dalam tanda backtick (`) di bawah.
        // Pastikan TIADA teks lain selain data CSV di dalam kawasan ini.
        const rawStudentDataCsv = `
no ic;nama;kelas;subjek;markah
111009060459;ABDUL SALAM BIN ABDUL RAUF;2 EFESIEN;BAHASA MELAYU;61
110822060860;CHAY POH LIN;2 EFESIEN;BAHASA MELAYU;44
111205011435;CHEAH DHITO HARLAN SYAH BIN MUHAMMAD AZLAN;2 EFESIEN;BAHASA MELAYU;26
110606011749;DAEVENDREN A/L GUNALAN;2 EFESIEN;BAHASA MELAYU;27
111118010653;ELFY RIZQIN BIN KHALID;2 EFESIEN;BAHASA MELAYU;70
110321011411;JEREMY TAN YUAN PING;2 EFESIEN;BAHASA MELAYU;12
101219080520;KAM YUN HAN;2 EFESIEN;BAHASA MELAYU;62
110821030950;MARSYANDA OLDELIA BINTI SEMAWI;2 EFESIEN;BAHASA MELAYU;72
110713010899;MUHAMMAD FAKHRUL AMIN BIN MOHD ANUAR;2 EFESIEN;BAHASA MELAYU;61
110618010911;MUHAMMAD FETIH NAUFAL BIN MOHD FAIDZAL;2 EFESIEN;BAHASA MELAYU;72
110530011709;MUHAMMAD FIRAS BIN MISRAN;2 EFESIEN;BAHASA MELAYU;53
110421011611;MUHAMMAD HAKIM HANIF BIN RASATU;2 EFESIEN;BAHASA MELAYU;50
110623010211;MUHAMMAD HAZIM IMAN BIN HAZMAN;2 EFESIEN;BAHASA MELAYU;72
110915010010;NG YEE QING;2 EFESIEN;BAHASA MELAYU;58
110818010326;NUR AINA ATHIRAH BINTI ZAIWIN;2 EFESIEN;BAHASA MELAYU;68
110120010690;NUR AINA DAMIA BINTI AZLAN SHAH;2 EFESIEN;BAHASA MELAYU;90
111115010375;NUR HARRAZ RIFQI BIN NOR AZLAN;2 EFESIEN;BAHASA MELAYU;56
111109010694;NUR QASEH QALESYAH BINTI SAHRIZAL;2 EFESIEN;BAHASA MELAYU;77
111118010266;NUR QASEH QATRUNNADA BINTI MOHD ZULKEFLEY;2 EFESIEN;BAHASA MELAYU;76
110921010930;QISYA QASREENA BINTI NORAZMAN;2 EFESIEN;BAHASA MELAYU;67
110330010437;TAM XAVIER;2 EFESIEN;BAHASA MELAYU;20
110602011995;TIEW JING KAI;2 EFESIEN;BAHASA MELAYU;36
110122011697;VITESH A/L CHENDRAN;2 EFESIEN;BAHASA MELAYU;25
110217011163;WAN MOHAMAD FAIQ QAYYUM BIN WAN MOHD FAUZI;2 EFESIEN;BAHASA MELAYU;56
111020010188;WONG YEE SHAN;2 EFESIEN;BAHASA MELAYU;50
110130010731;YOGA A/L JAYA KUMAR;2 EFESIEN;BAHASA MELAYU;30
110102011059;YUKEN A/L GOPAL;2 EFESIEN;BAHASA MELAYU;42
120914010800;AAFIYAH NURZAHRA BINTI AZLAN;1 ARIF;BAHASA MELAYU;84
120915010685;AATHI SHANKARAA A/L LACHUMANAN;1 ARIF;BAHASA MELAYU;66
120708010359;ALVIN HOW JUN SIANG;1 ARIF;BAHASA MELAYU;84
120805011003;AMAAR LUTHFI ISAAC BIN AZAMMUDIN;1 ARIF;BAHASA MELAYU;83
120907011776;CHAN YONG XI;1 ARIF;BAHASA MELAYU;86
121012010750;CHIN WEI XIN;1 ARIF;BAHASA MELAYU;59
120716011669;GOH CHENG WEI;1 ARIF;BAHASA MELAYU;73
120517010428;HOW YEN ERN;1 ARIF;BAHASA MELAYU;72
120714011227;ISHWARAN A/L KANNAN;1 ARIF;BAHASA MELAYU;62
121215011294;JANANI A/P CHNDRA KUMAR;1 ARIF;BAHASA MELAYU;73
120422011313;LEE ZHANG YU;1 ARIF;BAHASA MELAYU;27
120629011652;LILY LAIQAH BINTI MD RAFI;1 ARIF;BAHASA MELAYU;82
120226011471;LOO KAI JING;1 ARIF;BAHASA MELAYU;60
120806010432;MIRABELLE SHANA A/P MARKSTEWART;1 ARIF;BAHASA MELAYU;62
121225010025;MOHAMAD FARITH IRFAN BIN MOHAMAD FAIZAL;1 ARIF;BAHASA MELAYU;82
120206010017;MUHAMMAD ADAM MUKHRIZ BIN MUHAMMAD FAIZAL;1 ARIF;BAHASA MELAYU;91
120805010473;MUHAMMAD ASYWAD BIN NAJIB;1 ARIF;BAHASA MELAYU;65
121213101501;NAUFAL AIRISH BIN NAZARUL NAZZUAN;1 ARIF;BAHASA MELAYU;69
121017010434;NUR ALEEYA AISHAH BINTI MOHD FAIZAL;1 ARIF;BAHASA MELAYU;84
120730010566;NUR CARLISA BINTI BAHA;1 ARIF;BAHASA MELAYU;86
120708010682;NUR KHALISAH HANI BINTI MOHD AFFANDI;1 ARIF;BAHASA MELAYU;82
120201010288;NURLIYA ANISAH BINTI MOHD ROSMAN;1 ARIF;BAHASA MELAYU;72
120811140733;RUBENDRAN A/L VIMALAN;1 ARIF;BAHASA MELAYU;48
120713011284;SITI NUR HUMAIRAH HUSSEIN BINTI ABDUL MUHAIMIN;1 ARIF;BAHASA MELAYU;87
120522080252;TAN YU ENN;1 ARIF;BAHASA MELAYU;65
120901011409;THASVIN A/L KALIYAPAN;1 ARIF;BAHASA MELAYU;64
120210010124;TING WEE;1 ARIF;BAHASA MELAYU;78
120818011037;VARTA SARATHI A/L SAMUGAM;1 ARIF;BAHASA MELAYU;79
120306010161;ZAIRULHAKIMI BIN ZAIRULHISHAM;1 ARIF;BAHASA MELAYU;85
121121011699;AMMAR REEFQY BIN ARIFIN;1 INOVASI;BAHASA MELAYU;28
120917010179;ASYRAF MUSTAQIM BIN MULIADI;1 INOVASI;BAHASA MELAYU;28
110906011724;CHAN KAH KAH;1 INOVASI;BAHASA MELAYU;14
120211011241;DAMIEN ASYRAF BIN MOHD ZAKARIA;1 INOVASI;BAHASA MELAYU;41
111209020347;HOA JUN KAI;1 INOVASI;BAHASA MELAYU;8
121202010567;IZMAL MIQAIL BIN MOHD. IZWANUDDIN;1 INOVASI;BAHASA MELAYU;32
110904010576;JESICCA SEE HUI EN;1 INOVASI;BAHASA MELAYU;20
120521010930;LAU SHAN SHAN;1 INOVASI;BAHASA MELAYU;31
121031141131;LEAN YI CHEN;1 INOVASI;BAHASA MELAYU;34
120723010234;LOH ZHI XUAN;1 INOVASI;BAHASA MELAYU;36
121113011779;LOO SHARE KEONG;1 INOVASI;BAHASA MELAYU;22
120920010743;MUHAMMAD ADAM AL QAYYUM BIN MUHAMMAD SALLEH;1 INOVASI;BAHASA MELAYU;4
120602010369;MUHAMMAD AIDIL HAKIMIE BIN ROSLAN;1 INOVASI;BAHASA MELAYU;35
120630010307;MUHAMMAD ALIFF BIN AZWAN;1 INOVASI;BAHASA MELAYU;29
120309010183;MUHAMMAD ASYRAF BIN MOHD HAIRUDDIN;1 INOVASI;BAHASA MELAYU;43
120222010105;MUHAMMAD HAZIM IKRAM BIN JUSOH;1 INOVASI;BAHASA MELAYU;39
120611011507;MUHAMMAD HIQMAL BIN YUSRI;1 INOVASI;BAHASA MELAYU;51
121108010472;NUR AIEN KHAIRUNNISA BINTI ASMAFAIZAL;1 INOVASI;BAHASA MELAYU;54
120526011924;NUR ASLINDA BINTI ABDUL KHALID KHAIRI;1 INOVASI;BAHASA MELAYU;56
120126010914;NUR FIRZANA BINTI MOHAMAD HAMIM;1 INOVASI;BAHASA MELAYU;61
120219010294;NUR QISYA HADIRAH BINTI NOR AZRAN SHAH;1 INOVASI;BAHASA MELAYU;57
120831011672;NUR SYAZA ZAFIRAH BINTI MUHAMMAD NAZMI;1 INOVASI;BAHASA MELAYU;50
120416010592;NURUL ASYIQIN BINTI JUMARI;1 INOVASI;BAHASA MELAYU;61
121213010888;NURUL AUNI FIRDINA BINTI SANUDIN;1 INOVASI;BAHASA MELAYU;52
120127011687;PHOA ZI TIAN;1 INOVASI;BAHASA MELAYU;7
121009012448;PUTERI NUR EMALYN BINTI MOHAMED SAHARIL;1 INOVASI;BAHASA MELAYU;48
120921011350;SAFIYYA QADEEJA BINTI ZAMRI;1 INOVASI;BAHASA MELAYU;45
120322011121;SAJINES A/L MANOGAR;1 INOVASI;BAHASA MELAYU;9
121210010380;SITI NUR FATIHAH BINTI ROSLI;1 INOVASI;BAHASA MELAYU;22
120321011664;THIVASHINI A/P VASANTHAN;1 INOVASI;BAHASA MELAYU;40
121010011178;WONG YEE ROU;1 INOVASI;BAHASA MELAYU;46
110508081057;WONG ZHENG SENG;1 INOVASI;BAHASA MELAYU;17
110701011165;ABDUL QAYYUM IRFAN BIN FADZIL;2 KREATIF;BAHASA MELAYU;18
111111010087;ADAM DANISH BIN YUSRIZAL;2 KREATIF;BAHASA MELAYU;29
110408010964;CHONG EN XUAN;2 KREATIF;BAHASA MELAYU;20
100125011773;CHONG RUI CHENG;2 KREATIF;BAHASA MELAYU;5
101029011188;CHONG XIN YI;2 KREATIF;BAHASA MELAYU;10
110901011733;HEAH LI HAN;2 KREATIF;BAHASA MELAYU;6
110524011809;KABBINASHH A/L RAJA SEGHRAN;2 KREATIF;BAHASA MELAYU;7
100223060077;LAM KIN WENG;2 KREATIF;BAHASA MELAYU;5
110828010725;MOHAMAD FIRDAUS BIN NIZAM;2 KREATIF;BAHASA MELAYU;6
110821011397;MUHAMMAD AIMAN SHARIEZAN BIN ABDULLAH;2 KREATIF;BAHASA MELAYU;5
111204010107;MUHAMMAD AZRIL SYAZWAN BIN ABDUL RAHMAN;2 KREATIF;BAHASA MELAYU;8
110629011303;MUHAMMAD HAFIQ HAZWAN BIN ABDUL HAMID;2 KREATIF;BAHASA MELAYU;14
K2351608D;MUHAMMAD IMAM BAIHAQI BIN HUD;2 KREATIF;BAHASA MELAYU;24
110624010205;MUHAMMAD MIKAIL BIN SANI;2 KREATIF;BAHASA MELAYU;13
110829010487;MUHAMMAD QAYYUM ZIKRY BIN MD TARMIZI;2 KREATIF;BAHASA MELAYU;25
110516011083;MUHAMMAD SHAFRIL AFIQ BIN ABDULLAH;2 KREATIF;BAHASA MELAYU;13
111019011650;NOR AFIFATUL MUNAWARAH BINTI NASIR;2 KREATIF;BAHASA MELAYU;55
110612010806;NUR ALIYAH BINTI ABU BAKAR;2 KREATIF;BAHASA MELAYU;46
111111011610;PRISCILLA KEAMAN ANAK ROBIN;2 KREATIF;BAHASA MELAYU;45
110928010802;QISTINA DANIA BINTI MOHAMAD ZAMRI;2 KREATIF;BAHASA MELAYU;37
100129010903;RAY CHING RUI ZHE;2 KREATIF;BAHASA MELAYU;2
120101012163;SANTOSH A/L MOGANARAJ;2 KREATIF;BAHASA MELAYU;9
111222010522;SITI AISYAH AQILAH BINTI MOHAMED SHAFIE;2 KREATIF;BAHASA MELAYU;32
111119010890;SITI KHADIJAH BINTI MOHD HAIZAN;2 KREATIF;BAHASA MELAYU;35
111028030212;SITI NUR ZAHARAH BINTI SABRI;2 KREATIF;BAHASA MELAYU;17
CA660876;TANG RUI EN;2 KREATIF;BAHASA MELAYU;14
110418010669;WONG YUE XIN;2 KREATIF;BAHASA MELAYU;4
100915010839;YOONG KHA JUN;2 KREATIF;BAHASA MELAYU;8
111129011811;YUVA RAJ A/L MARIE;2 KREATIF;BAHASA MELAYU;16
`; 

        let studentData = [];

        // --- FUNGSI PARSE DATA ---
        function parseStudentData(rawData) {
            const allRecords = [];
            const lines = rawData.trim().split('\n'); 
            lines.forEach((line, index) => {
                if (line.trim() === "") return;
                const parts = line.split(';');
                if (parts.length < 3) return;
                // Abaikan baris tajuk jika ada
                const firstCol = parts[0].toLowerCase().trim();
                if (firstCol === 'no ic' || firstCol === 'kod_pelajar' || firstCol === 'no_kp') return;

                let noKp = parts[0].trim();
                // Tukar format saintifik (Excel) kepada teks penuh
                if (noKp.toUpperCase().includes('E+')) { 
                    noKp = Number(noKp).toString(); 
                }
                const nama = parts[1].trim();
                const kelas = parts[2].trim();

                // Loop untuk membaca pasangan subjek;markah
                for (let i = 3; i < parts.length; i += 2) {
                    const subjek = parts[i] ? parts[i].trim() : null;
                    const markah = parts[i + 1] ? parts[i + 1].trim() : null;
                    if (subjek && markah && subjek !== "" && markah !== "") {
                        allRecords.push({ no_kp: noKp, nama: nama, kelas: kelas, subjek: subjek, markah: parseInt(markah, 10) });
                    }
                }
            });
            return allRecords;
        }

        // --- PROSES DATA SECARA AUTOMATIK ---
        // Ini akan dijalankan sebaik sahaja halaman dibuka
        try {
            studentData = parseStudentData(rawStudentDataCsv);
            console.log(`Berjaya memuat naik ${studentData.length} rekod markah secara automatik.`);
        } catch (e) {
            console.error("Ralat memproses data CSV automatik:", e);
        }

        // --- (A) TETAPAN API GEMINI ---
        const apiKey = "AIzaSyBp5tIJl0R8y_Ggec-DQmDHfrzNgZOgrjU"; 
        const textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const ttsApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

        // (2) Rujukan DOM
        const studentIdInput = document.getElementById('studentIdInput');
        const checkButton = document.getElementById('checkButton');
        const resultsContainer = document.getElementById('resultsContainer');
        const studentNameEl = document.getElementById('studentName');
        const studentClassEl = document.getElementById('studentClass');
        const marksListEl = document.getElementById('marksList');
        const errorContainer = document.getElementById('errorContainer');
        
        // Gemini DOM
        const geminiSection = document.getElementById('geminiSection');
        const geminiLoading = document.getElementById('geminiLoading');
        const loadingText = document.getElementById('loadingText');
        
        const generateCommentButton = document.getElementById('generateCommentButton');
        const geminiResult = document.getElementById('geminiResult');
        const geminiCommentText = document.getElementById('geminiCommentText');
        
        const studyPlanButton = document.getElementById('studyPlanButton');
        const studyPlanResult = document.getElementById('studyPlanResult');
        const studyPlanText = document.getElementById('studyPlanText');

        const careerButton = document.getElementById('careerButton');
        const careerResult = document.getElementById('careerResult');
        const careerText = document.getElementById('careerText');

        const readAloudButton = document.getElementById('readAloudButton');
        const ttsLoading = document.getElementById('ttsLoading');
        const audioPlayer = document.getElementById('audioPlayer');
        
        // Admin DOM
        const dataTextArea = document.getElementById('dataTextArea');
        const loadDataButton = document.getElementById('loadDataButton');
        const dataLoadMessage = document.getElementById('dataLoadMessage');
        const adminSection = document.getElementById('adminSection');

        let currentStudentRecords = [];
        let fullTextToRead = "";

        // --- FUNGSI MUAT NAIK DATA (ADMIN) ---
        function loadData() {
            const rawData = dataTextArea.value;
            if (rawData.trim() === "") { showMessage('Ruangan data tidak boleh kosong.', true); return; }
            try {
                const newData = parseStudentData(rawData);
                if (newData.length === 0) throw new Error('Format data tidak sah.');
                studentData = newData; 
                showMessage(`Berjaya memuat naik ${studentData.length} rekod.`, false);
                setTimeout(() => { adminSection.removeAttribute('open'); dataLoadMessage.classList.add('hidden'); }, 1500);
            } catch (error) { showMessage(`Ralat: ${error.message}`, true); }
        }
        function showMessage(msg, isError) {
            dataLoadMessage.textContent = msg;
            dataLoadMessage.className = `text-center font-medium p-2 rounded-lg text-sm ${isError ? 'text-red-700 bg-red-100' : 'text-green-700 bg-green-100'}`;
        }

        // --- LOGIK UTAMA ---
        function calculateGrade(markah) {
            const mark = parseInt(markah, 10);
            if (mark >= 82) return { gred: 'A', status: 'Cemerlang' };
            if (mark >= 66) return { gred: 'B', status: 'Kepujian' };
            if (mark >= 50) return { gred: 'C', status: 'Baik' };
            if (mark >= 35) return { gred: 'D', status: 'Memuaskan' };
            if (mark >= 20) return { gred: 'E', status: 'Mencapai Tahap Minimum' };
            return { gred: 'F', status: 'Belum Mencapai Tahap Minimum' };
        }

        function checkMarks() {
            let rawInput = studentIdInput.value.trim();
            resetUI();
            if (!rawInput) { showError('Sila masukkan No Kad Pengenalan anda.'); return; }
            if (studentData.length === 0) { showError('Harap maaf, data markah belum dimuat naik ke dalam sistem.'); return; }
            let normalizedInput = rawInput.toUpperCase().includes('E+') ? Number(rawInput).toString() : rawInput;
            const matchedRecords = studentData.filter(s => String(s.no_kp).toUpperCase() === normalizedInput.toUpperCase());
            if (matchedRecords.length === 0) { showError('No Kad Pengenalan tidak ditemui. Sila semak dan cuba lagi.'); return; }
            displayResults(matchedRecords);
        }

        function resetUI() {
            resultsContainer.classList.add('hidden'); errorContainer.classList.add('hidden');
            marksListEl.innerHTML = ''; geminiSection.classList.add('hidden'); 
            geminiResult.classList.add('hidden'); studyPlanResult.classList.add('hidden'); careerResult.classList.add('hidden');
            generateCommentButton.classList.remove('hidden'); studyPlanButton.classList.add('hidden'); careerButton.classList.add('hidden');
            audioPlayer.pause(); audioPlayer.src = "";
        }
        function showError(msg) { errorContainer.textContent = msg; errorContainer.classList.remove('hidden'); }

        function displayResults(records) {
            currentStudentRecords = records;
            studentNameEl.textContent = records[0].nama.toUpperCase();
            studentClassEl.textContent = `Kelas: ${records[0].kelas}`;
            fullTextToRead = `Keputusan untuk ${records[0].nama}, dari ${records[0].kelas}.\n`;
            records.forEach(r => {
                const { gred, status } = calculateGrade(r.markah);
                fullTextToRead += `${r.subjek}: ${r.markah}%, Gred ${gred}.\n`;
                marksListEl.innerHTML += `
                    <div class="bg-gray-50 p-5 rounded-xl shadow-md border border-gray-200">
                        <p class="text-xl font-semibold text-gray-900">${r.subjek}</p>
                        <div class="mt-2 flex items-end justify-between">
                            <div><p class="text-4xl font-bold text-blue-600">${r.markah}%</p></div>
                            <div class="text-right"><p class="text-2xl font-semibold text-blue-500">${gred}</p><p class="text-sm text-gray-600">${status}</p></div>
                        </div>
                    </div>`;
            });
            resultsContainer.classList.remove('hidden'); geminiSection.classList.remove('hidden');
        }

        // --- FUNGSI GEMINI ---
        async function fetchWithBackoff(url, options, maxRetries=2) {
             let delay=1000; for(let i=0;i<maxRetries;i++){ try{const res=await fetch(url,options);if(res.ok)return res.json();if(res.status===429){await new Promise(r=>setTimeout(r,delay));delay*=2;}else throw new Error(res.status);}catch(e){if(i===maxRetries-1)throw e;await new Promise(r=>setTimeout(r,delay));delay*=2;}}}

        async function callGemini(prompt, systemPrompt) {
            const payload = { contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
            try {
                const res = await fetchWithBackoff(textApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                return res.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (e) { return null; }
        }

        // 1. Ulasan Umum
        async function handleGenerateComment() {
            if (currentStudentRecords.length === 0) return;
            geminiLoading.classList.remove('hidden'); loadingText.textContent = "Menganalisis prestasi keseluruhan...";
            generateCommentButton.classList.add('hidden');
            const marksStr = currentStudentRecords.map(r => `${r.subjek}: ${r.markah}% (${calculateGrade(r.markah).gred})`).join(', ');
            const comment = await callGemini(
                `Beri ulasan ringkas (maksimum 3 ayat) untuk pelajar: ${currentStudentRecords[0].nama}. Markah: ${marksStr}.`,
                "Anda adalah guru penasihat yang positif. Beri ulasan ringkas dalam Bahasa Melayu. Puji yang cemerlang, beri galakan untuk yang lemah."
            );
            geminiLoading.classList.add('hidden');
            if (comment) {
                geminiCommentText.innerHTML = comment; geminiResult.classList.remove('hidden');
                fullTextToRead += `\nUlasan Guru AI:\n ${comment}`;
                // Tunjuk butang fitur seterusnya
                studyPlanButton.classList.remove('hidden'); careerButton.classList.remove('hidden');
            } else {
                geminiCommentText.innerText = 'Maaf, ulasan tidak dapat dijana buat masa ini.'; geminiResult.classList.remove('hidden');
            }
        }

        // 2. Pelan Ulangkaji (Study Plan)
        async function handleStudyPlan() {
            geminiLoading.classList.remove('hidden'); loadingText.textContent = "Menjana pelan ulangkaji...";
            studyPlanButton.classList.add('hidden');
            // Cari subjek lemah (C, D, E, F)
            const weakSubjects = currentStudentRecords.filter(r => ['C','D','E','F'].includes(calculateGrade(r.markah).gred)).map(r => r.subjek).join(', ');
            const promptSubject = weakSubjects || "semua subjek untuk pengukuhan";

            const plan = await callGemini(
                `Bina jadual ulangkaji ringkas (1 minggu) fokus kepada subjek: ${promptSubject}.`,
                "Anda pakar motivasi. Berikan jawapan dalam format HTML (guna <ul><li>) dalam Bahasa Melayu. Jadual mestilah ringkas dan boleh dicapai oleh pelajar sekolah menengah."
            );
            geminiLoading.classList.add('hidden');
            if (plan) { studyPlanText.innerHTML = plan; studyPlanResult.classList.remove('hidden'); }
        }

        // 3. Cadangan Kerjaya
        async function handleCareer() {
            geminiLoading.classList.remove('hidden'); loadingText.textContent = "Menganalisis potensi kerjaya...";
            careerButton.classList.add('hidden');
            // Cari subjek kuat (A, B)
            const strongSubjects = currentStudentRecords.filter(r => ['A','B'].includes(calculateGrade(r.markah).gred)).map(r => r.subjek).join(', ');
            const promptSubject = strongSubjects || "minat umum pelajar";

            const career = await callGemini(
                `Berdasarkan kekuatan dalam subjek: ${promptSubject}, cadangkan 3 bidang kerjaya atau aliran sekolah yang sesuai.`,
                "Anda kaunselor kerjaya. Berikan jawapan dalam format HTML (guna <ol><li>) dalam Bahasa Melayu. Beri sebab ringkas kenapa bidang itu sesuai."
            );
            geminiLoading.classList.add('hidden');
            if (career) { careerText.innerHTML = career; careerResult.classList.remove('hidden'); }
        }

        // 4. TTS (Read Aloud)
        async function handleReadAloud() {
            if (!fullTextToRead) return;
            ttsLoading.classList.remove('hidden'); readAloudButton.disabled = true;
            try {
                const res = await fetchWithBackoff(ttsApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: fullTextToRead }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } }, model: "gemini-2.5-flash-preview-tts" }) });
                const audioData = res?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (audioData) {
                     const wav = pcmToWav(new Int16Array(base64ToArrayBuffer(audioData)), 24000);
                     audioPlayer.src = URL.createObjectURL(wav); audioPlayer.play();
                }
            } catch (e) { console.error(e); }
            finally { ttsLoading.classList.add('hidden'); readAloudButton.disabled = false; }
        }
        function base64ToArrayBuffer(b64){const b=atob(b64),l=b.length,u=new Uint8Array(l);for(let i=0;i<l;i++)u[i]=b.charCodeAt(i);return u.buffer;}
        function pcmToWav(pcm,r){const c=1,b=16,d=pcm.length*2,bf=new ArrayBuffer(44+d),v=new DataView(bf);wS(v,0,'RIFF');v.setUint32(4,36+d,true);wS(v,8,'WAVE');wS(v,12,'fmt ');v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,c,true);v.setUint32(24,r,true);v.setUint32(28,r*c*2,true);v.setUint16(32,c*2,true);v.setUint16(34,b,true);wS(v,36,'data');v.setUint32(40,d,true);for(let i=0;i<pcm.length;i++)v.setInt16(44+i*2,pcm[i],true);return new Blob([v],{type:'audio/wav'});}
        function wS(v,o,s){for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i));}

        loadDataButton.addEventListener('click', loadData);
        checkButton.addEventListener('click', checkMarks);
        generateCommentButton.addEventListener('click', handleGenerateComment);
        studyPlanButton.addEventListener('click', handleStudyPlan);
        careerButton.addEventListener('click', handleCareer);
        readAloudButton.addEventListener('click', handleReadAloud);
        studentIdInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') checkMarks(); });
    </script>
</body>
</html>

